name: Auto Assignment

on:
  pull_request_target:
    types: [opened, reopened, synchronize]

jobs:
  assign:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: 'Auto PR Assignment & Reviewer Request'
        uses: actions/github-script@v7
        with:
          script: |
            const creator = context.payload.pull_request.user.login;

            try {
              // 1. GitHub API를 통해 CODEOWNERS 읽기 (Checkout 없이 처리)
              const { data: codeownersFile } = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: '.github/CODEOWNERS',
                ref: context.payload.pull_request.head.sha // 현재 PR의 변경사항을 즉시 반영하려면 head.sha 추천
              });

              const content = Buffer.from(codeownersFile.content, 'base64').toString('utf8');
              const matches = content.match(/@[\w-]+/g);
              const teamMembers = matches ? [...new Set(matches.map(m => m.replace('@', '')))] : [];

              console.log(`Detected team members: ${teamMembers.join(', ')}`);

              // 2. 담당자 지정 (Assignee)
              await github.rest.issues.addAssignees({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                assignees: [creator]
              });

              // 3. 리뷰어 요청 (Reviewers)
              const reviewers = teamMembers.filter(member => member !== creator);
              reviewers.push('gemini-code-assist[bot]');

              console.log(`Requesting review from: ${reviewers.join(', ')}`);

              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
                reviewers: reviewers
              });

            } catch (error) {
              console.log("Process failed. This might be because the file is missing or a user is not a collaborator. Error: " + error.message);
            }
